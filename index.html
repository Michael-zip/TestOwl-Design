<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TestOwl - Create & Share Quizzes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <div class="landing-page">
            <div class="hero-section">
                <div class="animated-background">
                    <div class="particle"></div>
                    <div class="particle"></div>
                    <div class="particle"></div>
                    <div class="particle"></div>
                </div>
                <div class="hero-split">
                    <div class="hero-content">
                        <div class="hero-text">
                            <div class="emoji-title">
                                <span class="graduation-cap">ðŸŽ“</span>
                                <span class="app-title">TestOwl</span>
                            </div>
                            <h1 class="hero-title">Master Your Knowledge</h1>
                            <p class="hero-subtitle">Create engaging quizzes offline, share them with ease, and enhance learning outcomes with TestOwl's intuitive platform.</p>
                            <div class="hero-actions">
                                <button class="btn btn-primary glow-effect" onclick="showCreateQuiz()">
                                    <i class="fas fa-plus"></i>
                                    Create Quiz
                                </button>
                                <button class="btn btn-secondary shine-effect" onclick="showImportQuiz()">
                                    <i class="fas fa-file-import"></i>
                                    Import Quiz
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="hero-image">
                        <div class="floating-cards">
                            <div class="preview-card">
                                <div class="preview-header"></div>
                                <div class="preview-content">
                                    <div class="preview-line"></div>
                                    <div class="preview-line"></div>
                                    <div class="preview-line short"></div>
                                </div>
                            </div>
                            <div class="preview-card">
                                <div class="preview-header"></div>
                                <div class="preview-content">
                                    <div class="preview-line"></div>
                                    <div class="preview-line"></div>
                                    <div class="preview-line short"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="features-section">
                <h2 class="section-title">Why Choose TestOwl?</h2>
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon-wrapper">
                            <i class="fas fa-laptop-code feature-icon"></i>
                        </div>
                        <h3 class="feature-title">100% Offline</h3>
                        <p class="feature-description">Build and run quizzes completely offline. Your data never leaves your device - it's downloaded and stored locally.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon-wrapper">
                            <i class="fas fa-puzzle-piece feature-icon"></i>
                        </div>
                        <h3 class="feature-title">Simple Sharing</h3>
                        <p class="feature-description">Download your quizzes as encrypted .qowl files and share them however you prefer. You control your content.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon-wrapper">
                            <i class="fas fa-brain feature-icon"></i>
                        </div>
                        <h3 class="feature-title">Better Learning</h3>
                        <p class="feature-description">Smart question shuffling and instant feedback help improve understanding and knowledge retention.</p>
                    </div>
                </div>
            </div>

            <div class="workflow-section">
                <h2 class="section-title">How It Works</h2>
                <div class="workflow-steps">
                    <div class="workflow-step">
                        <div class="step-icon">
                            <i class="fas fa-pencil-alt"></i>
                        </div>
                        <div class="step-content">
                            <h3>Create Locally</h3>
                            <p>Design your quiz right on your device. Add questions, customize options, and include explanations - all without needing to be online.</p>
                        </div>
                    </div>
                    <div class="workflow-step">
                        <div class="step-icon">
                            <i class="fas fa-download"></i>
                        </div>
                        <div class="step-content">
                            <h3>Download & Share</h3>
                            <p>Save your quiz as an encrypted .qowl file on your device. Share it through email, messaging, or any way you prefer.</p>
                        </div>
                    </div>
                    <div class="workflow-step">
                        <div class="step-icon">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <div class="step-content">
                            <h3>Learn & Improve</h3>
                            <p>Take quizzes offline, get instant feedback, and track your progress to enhance your learning experience.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="cta-section">
                <div class="cta-content">
                    <h2>Start Creating Today</h2>
                    <p>Build your first quiz in minutes - completely free and offline!</p>
                    <button class="btn btn-primary glow-effect" onclick="showCreateQuiz()">
                        <i class="fas fa-rocket"></i>
                        Get Started
                    </button>
                </div>
            </div>
        </div>

        <!-- Quiz Builder View (Initially Hidden) -->
        <div class="quiz-builder-view" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2>Create New Quiz</h2>
                </div>
                <div class="card-body">
                    <form id="quizForm">
                        <div class="form-group">
                            <label for="quizTitle">Quiz Title</label>
                            <input type="text" id="quizTitle" class="form-input" placeholder="Enter quiz title" required>
                        </div>
                        <div class="form-group">
                            <label for="quizDescription">Description</label>
                            <textarea id="quizDescription" class="form-input" placeholder="Enter quiz description"></textarea>
                        </div>
                        <div id="questionsContainer" class="questions-list">
                            <!-- Questions will be added here -->
                        </div>
                        <button type="button" class="btn btn-secondary add-question-btn" onclick="addQuestion()">
                            <i class="fas fa-plus"></i>
                            Add Question
                        </button>
                        <div class="quiz-actions">
                            <button type="button" class="btn btn-primary" onclick="saveQuiz()">
                                <i class="fas fa-save"></i>
                                Save Quiz
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Stored Quizzes View (Initially Hidden) -->
        <div class="stored-quizzes-view" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2>Your Quizzes</h2>
                </div>
                <div class="card-body" id="storedQuizzesList">
                    <!-- Quizzes will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="showHome()">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </div>
        <div class="nav-item" onclick="showCreateQuiz()">
            <i class="fas fa-plus"></i>
            <span>Create</span>
        </div>
        <div class="nav-item" onclick="showStoredQuizzes()">
            <i class="fas fa-folder"></i>
            <span>Stored</span>
        </div>
        <div class="nav-item" onclick="showImportQuiz()">
            <i class="fas fa-file-import"></i>
            <span>Import</span>
        </div>
    </nav>

    <script>
        // View Management
        function showHome() {
            try {
                // Hide all views first
                hideAllViews();
                
                // Show home view
                const landingPage = document.querySelector('.landing-page');
                if (!landingPage) {
                    throw new Error('Landing page element not found');
                }
                landingPage.style.display = 'block';
                
                // Update navigation
                updateActiveNavItem('home');
            } catch (error) {
                console.error('Error showing home view:', error);
                showToast('Failed to show home view', 'error');
            }
        }

        function showCreateQuiz() {
            try {
                // Hide all views first
                hideAllViews();
                
                // Show quiz builder view
                const builderView = document.querySelector('.quiz-builder-view');
                if (!builderView) {
                    throw new Error('Quiz builder view not found');
                }
                builderView.style.display = 'block';
                
                // Update navigation
                updateActiveNavItem('create');
                
                // Initialize empty quiz if needed
                if (!document.querySelector('.question-item')) {
                    addQuestion();
                }
            } catch (error) {
                console.error('Error showing quiz builder:', error);
                showToast('Failed to show quiz builder', 'error');
            }
        }

        function showStoredQuizzes() {
            try {
                // Hide all views first
                hideAllViews();
                
                // Show stored quizzes view
                const storedView = document.querySelector('.stored-quizzes-view');
                if (!storedView) {
                    throw new Error('Stored quizzes view not found');
                }
                storedView.style.display = 'block';
                
                // Update navigation
                updateActiveNavItem('stored');
                
                // Load stored quizzes
                loadStoredQuizzes();
            } catch (error) {
                console.error('Error showing stored quizzes:', error);
                showToast('Failed to show stored quizzes', 'error');
            }
        }

        function showImportQuiz() {
            try {
                // Create file input if it doesn't exist
                let input = document.getElementById('quizFileInput');
                if (!input) {
                    input = document.createElement('input');
                    input.type = 'file';
                    input.id = 'quizFileInput';
                    input.accept = '.qowl';
                    input.style.display = 'none';
                    input.onchange = handleFileImport;
                    document.body.appendChild(input);
                }
                
                // Reset input value to allow selecting the same file again
                input.value = '';
                input.click();
                
                // Update navigation
                updateActiveNavItem('import');
            } catch (error) {
                console.error('Error showing import dialog:', error);
                showToast('Failed to show import dialog', 'error');
            }
        }

        // Helper function to hide all views
        function hideAllViews() {
            const views = [
                '.landing-page',
                '.quiz-builder-view',
                '.stored-quizzes-view',
                '.quiz-view',
                '.quiz-results'
            ];
            
            views.forEach(selector => {
                const view = document.querySelector(selector);
                if (view) {
                    view.style.display = 'none';
                }
            });
        }

        // Update the navigation item selection with proper validation
        function updateActiveNavItem(view) {
            try {
                const navItems = document.querySelectorAll('.nav-item');
                if (!navItems || navItems.length === 0) {
                    throw new Error('Navigation items not found');
                }
                
                // Remove active class from all items
                navItems.forEach(item => item.classList.remove('active'));
                
                // Map view names to indices
                const viewIndices = {
                    'home': 0,
                    'create': 1,
                    'stored': 2,
                    'import': 3
                };
                
                const index = viewIndices[view];
                if (index === undefined) {
                    throw new Error('Invalid view name');
                }
                
                // Add active class to selected item
                const activeItem = navItems[index];
                if (!activeItem) {
                    throw new Error('Active navigation item not found');
                }
                activeItem.classList.add('active');
            } catch (error) {
                console.error('Error updating navigation:', error);
            }
        }

        // Update the navigation event listeners
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Get navigation container
                const nav = document.querySelector('.bottom-nav');
                if (!nav) {
                    throw new Error('Navigation container not found');
                }
                
                // Remove existing click handlers
                const navItems = nav.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    const newItem = item.cloneNode(true);
                    item.parentNode.replaceChild(newItem, item);
                });
                
                // Add new click handlers with proper event delegation
                nav.addEventListener('click', function(e) {
                    const navItem = e.target.closest('.nav-item');
                    if (!navItem) return;
                    
                    // Prevent default behavior
                    e.preventDefault();
                    
                    // Get navigation index
                    const index = Array.from(navItems).indexOf(navItem);
                    
                    // Call appropriate function based on index
                    switch (index) {
                        case 0:
                            showHome();
                            break;
                        case 1:
                            showCreateQuiz();
                            break;
                        case 2:
                            showStoredQuizzes();
                            break;
                        case 3:
                            showImportQuiz();
                            break;
                    }
                });
                
                // Initialize home view
                showHome();
            } catch (error) {
                console.error('Error initializing navigation:', error);
                showToast('Failed to initialize navigation', 'error');
            }
        });

        // Add validation for quiz state
        function validateQuizState() {
            if (!window.currentQuiz) {
                throw new Error('No quiz is currently loaded');
            }
            
            if (!Array.isArray(window.currentQuiz.questions)) {
                throw new Error('Invalid quiz structure: questions array is missing');
            }
            
            if (!Array.isArray(window.userAnswers)) {
                throw new Error('User answers array is not initialized');
            }
            
            if (window.currentQuestionIndex === undefined || window.currentQuestionIndex < 0) {
                throw new Error('Invalid question index');
            }
        }

        // Update quiz view functions with validation
        function showQuizView(showSuccessToast = true) {
            try {
                validateQuizState();
                
                // Hide all other views
                hideAllViews();
                
                // Generate and show quiz view HTML
                const container = document.querySelector('.container');
                if (!container) {
                    throw new Error('Container element not found');
                }
                
                const quizHTML = generateQuizViewHTML();
                container.innerHTML = quizHTML;
                
                // Update navigation state
                updateNavigationState();
                
                // Only show success toast if explicitly requested
                if (showSuccessToast) {
                    showToast('Quiz loaded successfully', 'success');
                }
            } catch (error) {
                console.error('Error showing quiz view:', error);
                showToast(`Failed to display quiz: ${error.message}`, 'error');
                
                // Fallback to home view on error
                showHome();
            }
        }

        // Helper function to generate quiz view HTML
        function generateQuizViewHTML() {
            if (!window.currentQuiz) {
                throw new Error('No quiz loaded');
            }
            
            return `
                <div class="quiz-view animate-fade">
                    <div class="card">
                        <div class="card-header">
                            <h2>${window.currentQuiz.title}</h2>
                            ${window.currentQuiz.description ? `<p class="quiz-description">${window.currentQuiz.description}</p>` : ''}
                        </div>
                        <div class="card-body">
                            <form id="quizForm" onsubmit="submitQuiz(event)">
                                <div id="questionsContainer" class="questions-container">
                                    ${renderCurrentQuestion()}
                                </div>
                                <div class="quiz-navigation">
                                    <button type="button" class="nav-btn" onclick="previousQuestion()" id="prevBtn" disabled>
                                        <i class="fas fa-arrow-left"></i> Previous
                                    </button>
                                    <div class="question-progress">
                                        <span id="questionProgress">Question ${window.currentQuestionIndex + 1} of ${window.currentQuiz.questions.length}</span>
                                        <div class="progress-dots" id="progressDots">
                                            ${generateProgressDots(window.currentQuiz.questions.length)}
                                        </div>
                                    </div>
                                    <button type="button" class="nav-btn" onclick="nextQuestion()" id="nextBtn">
                                        Next <i class="fas fa-arrow-right"></i>
                                    </button>
                                </div>
                                <div class="mt-4" id="submitContainer" style="display: none;">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-check"></i> Submit Quiz
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }

        // Encryption utilities
        const CryptoUtils = {
            // Generate a random salt
            generateSalt: function(length = 16) {
                const array = new Uint8Array(length);
                crypto.getRandomValues(array);
                return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
            },
            
            // Derive key from password and salt
            deriveKey: async function(password, salt) {
                const encoder = new TextEncoder();
                const passwordData = encoder.encode(password);
                const saltData = encoder.encode(salt);
                
                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    passwordData,
                    { name: 'PBKDF2' },
                    false,
                    ['deriveBits', 'deriveKey']
                );
                
                return await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: saltData,
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    true,
                    ['encrypt', 'decrypt']
                );
            },
            
            // Encrypt data
            encrypt: async function(data, password) {
                const salt = this.generateSalt();
                const key = await this.deriveKey(password, salt);
                const encoder = new TextEncoder();
                const dataBuffer = encoder.encode(JSON.stringify(data));
                
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const encrypted = await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv },
                    key,
                    dataBuffer
                );
                
                return {
                    version: 1,
                    salt: salt,
                    iv: Array.from(iv, byte => byte.toString(16).padStart(2, '0')).join(''),
                    data: Array.from(new Uint8Array(encrypted), byte => byte.toString(16).padStart(2, '0')).join('')
                };
            },
            
            // Decrypt data
            decrypt: async function(encryptedData, password) {
                try {
                    const salt = encryptedData.salt;
                    const key = await this.deriveKey(password, salt);
                    const iv = new Uint8Array(encryptedData.iv.match(/.{2}/g).map(byte => parseInt(byte, 16)));
                    const data = new Uint8Array(encryptedData.data.match(/.{2}/g).map(byte => parseInt(byte, 16)));
                    
                    const decrypted = await crypto.subtle.decrypt(
                        { name: 'AES-GCM', iv },
                        key,
                        data
                    );
                    
                    const decoder = new TextDecoder();
                    return JSON.parse(decoder.decode(decrypted));
                } catch (error) {
                    throw new Error('Invalid password or corrupted data');
                }
            }
        };

        // Update the password modal function to match delete confirmation style
        function showPasswordModal(title, message) {
            return new Promise((resolve) => {
                // Remove any existing modals
                const existingModal = document.querySelector('.confirm-modal');
                if (existingModal) {
                    existingModal.remove();
                }

                const modalHTML = `
                    <div class="confirm-modal">
                        <div class="confirm-modal-content">
                            <div class="confirm-modal-header">
                                <i class="fas fa-lock"></i>
                                <h3>${title}</h3>
                            </div>
                            <div class="confirm-modal-body">
                                <p>${message}</p>
                                <div class="form-group">
                                    <label for="quizPassword">Password</label>
                                    <div class="password-field">
                                        <input type="password" id="quizPassword" class="form-input" 
                                               placeholder="Enter password (leave blank for no password)">
                                        <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility(this)"></i>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="confirmPassword">Confirm Password</label>
                                    <div class="password-field">
                                        <input type="password" id="confirmPassword" class="form-input" 
                                               placeholder="Confirm password">
                                        <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility(this)"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="confirm-modal-actions">
                                <button class="btn btn-secondary" onclick="closePasswordModal(this)">
                                    Cancel
                                </button>
                                <button class="btn btn-primary" onclick="submitPasswordWithConfirmation(this)">
                                    Confirm
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                const modal = document.querySelector('.confirm-modal');
                
                // Force reflow and add show class
                modal.offsetHeight;
                modal.classList.add('show');
                
                // Focus password input after animation
                setTimeout(() => {
                    document.getElementById('quizPassword').focus();
                }, 300);

                // Handle password submission with confirmation
                window.submitPasswordWithConfirmation = function(button) {
                    const password = document.getElementById('quizPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    
                    // If password is blank, allow it
                    if (!password && !confirmPassword) {
                        closePasswordModal(button);
                        resolve('');
                        return;
                    }
                    
                    // Check if passwords match
                    if (password !== confirmPassword) {
                        showToast('Passwords do not match', 'error');
                        return;
                    }
                    
                    closePasswordModal(button);
                    resolve(password);
                };
            });
        }

        // Add close password modal function
        function closePasswordModal(button) {
            const modal = button.closest('.confirm-modal');
            modal.classList.remove('show');
            setTimeout(() => modal.remove(), 300);
        }

        // Update the styles for the modal
        const styleSheet = document.createElement('style');
        styleSheet.textContent = `
            /* Enhanced Modal Styles */
            .confirm-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(4px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .confirm-modal.show {
                opacity: 1;
            }

            .confirm-modal-content {
                background: var(--surface-light);
                border-radius: var(--border-radius);
                padding: var(--spacing-lg);
                width: 90%;
                max-width: 500px;
                border: 1px solid var(--border);
                box-shadow: var(--shadow-lg);
                transform: translateY(-20px);
                transition: transform 0.3s ease;
            }

            .confirm-modal.show .confirm-modal-content {
                transform: translateY(0);
            }

            .confirm-modal-header {
                display: flex;
                align-items: center;
                gap: var(--spacing-md);
                margin-bottom: var(--spacing-lg);
                padding-bottom: var(--spacing-md);
                border-bottom: 1px solid var(--border);
            }

            .confirm-modal-header i {
                font-size: 24px;
                color: var(--primary-color);
            }

            .confirm-modal-header h3 {
                margin: 0;
                color: var(--text);
                font-size: 1.25rem;
            }

            .confirm-modal-body {
                color: var(--text-secondary);
                margin-bottom: var(--spacing-lg);
            }

            .confirm-modal-body .form-group {
                margin-top: var(--spacing-md);
            }

            .confirm-modal-actions {
                display: flex;
                gap: var(--spacing-md);
                justify-content: flex-end;
                padding-top: var(--spacing-md);
                border-top: 1px solid var(--border);
            }

            .password-field {
                position: relative;
                margin-top: var(--spacing-xs);
            }

            .toggle-password {
                position: absolute;
                right: 12px;
                top: 50%;
                transform: translateY(-50%);
                cursor: pointer;
                color: var(--text-secondary);
                transition: color 0.2s ease;
                padding: var(--spacing-xs);
            }

            .toggle-password:hover {
                color: var(--primary-color);
            }

            .confirm-modal-body label {
                display: block;
                margin-bottom: var(--spacing-xs);
                color: var(--text);
                font-weight: 500;
            }

            .confirm-modal-body .form-input {
                width: 100%;
                background: var(--surface-dark);
                border: 1px solid var(--border);
                padding: var(--spacing-md);
                color: var(--text);
                transition: all 0.2s ease;
            }

            .confirm-modal-body .form-input:focus {
                border-color: var(--primary-color);
                box-shadow: 0 0 0 2px var(--glow-color);
            }

            @media (max-width: 768px) {
                .confirm-modal-content {
                    width: 95%;
                    margin: var(--spacing-md);
                }
            }
        `;

        document.head.appendChild(styleSheet);

        // Add password visibility toggle
        function togglePasswordVisibility(icon) {
            const input = icon.previousElementSibling;
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        // Store quiz in local storage
        function storeQuiz(quiz) {
            try {
                const storedQuizzes = JSON.parse(localStorage.getItem('storedQuizzes') || '[]');
                const quizToStore = {
                    ...quiz,
                    id: Date.now().toString(36),
                    timestamp: Date.now()
                };
                storedQuizzes.push(quizToStore);
                localStorage.setItem('storedQuizzes', JSON.stringify(storedQuizzes));
                showToast('Quiz stored successfully!', 'success');
                showStoredQuizzes(); // Refresh the view
            } catch (error) {
                showToast('Failed to store quiz', 'error');
            }
        }

        // Delete quiz from storage
        function deleteQuiz(quizId) {
            try {
                if (!confirm('Are you sure you want to delete this quiz?')) return;
                
                const storedQuizzes = JSON.parse(localStorage.getItem('storedQuizzes') || '[]');
                const updatedQuizzes = storedQuizzes.filter(q => q.id !== quizId);
                localStorage.setItem('storedQuizzes', JSON.stringify(updatedQuizzes));
                showToast('Quiz deleted successfully!', 'success');
                loadStoredQuizzes(); // Refresh the list
            } catch (error) {
                showToast('Failed to delete quiz', 'error');
            }
        }

        // Start quiz with improved error handling
        function startQuiz(quizId) {
            try {
                // Validate quiz ID
                if (!quizId) {
                    throw new Error('Quiz ID is missing');
                }

                // Get stored quizzes with error handling
                let storedQuizzes;
                try {
                    storedQuizzes = JSON.parse(localStorage.getItem('storedQuizzes') || '[]');
                } catch (parseError) {
                    throw new Error('Failed to load stored quizzes: Invalid storage data');
                }

                // Find the quiz
                const quiz = storedQuizzes.find(q => q.id === quizId);
                if (!quiz) {
                    throw new Error('Quiz not found in storage');
                }

                // Validate quiz structure
                if (!quiz.questions || !Array.isArray(quiz.questions)) {
                    throw new Error('Quiz is invalid: No questions found');
                }

                if (quiz.questions.length === 0) {
                    throw new Error('Quiz has no questions');
                }

                // Validate each question
                quiz.questions.forEach((question, index) => {
                    if (!question.question) {
                        throw new Error(`Question ${index + 1} is missing text`);
                    }
                    if (!question.options || !Array.isArray(question.options) || question.options.length < 2) {
                        throw new Error(`Question ${index + 1} has invalid options`);
                    }
                    if (question.type === 'single' && !question.correctAnswer) {
                        throw new Error(`Question ${index + 1} is missing correct answer`);
                    }
                    if (question.type === 'multiple' && (!question.correctAnswers || !Array.isArray(question.correctAnswers))) {
                        throw new Error(`Question ${index + 1} has invalid correct answers`);
                    }
                });

                // Store current quiz for taking with shuffled questions
                window.currentQuiz = {
                    ...quiz,
                    questions: shuffleArray([...quiz.questions])
                };

                // Initialize quiz state
                window.currentQuestionIndex = 0;
                window.userAnswers = new Array(quiz.questions.length).fill(null).map(() => []);
                
                // Show quiz view
                showQuizView(false); // Pass false to prevent showing success toast
                showToast('Quiz started successfully', 'success');
            } catch (error) {
                console.error('Quiz start error:', error);
                showToast(`Failed to start quiz: ${error.message}`, 'error');
            }
        }

        // Shuffle array (for randomizing questions)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Validate quiz before saving
        function validateQuiz() {
            const title = document.getElementById('quizTitle').value.trim();
            if (!title) {
                throw new Error('Please enter a quiz title');
            }

            const questions = Array.from(document.querySelectorAll('.question-item'));
            if (questions.length === 0) {
                throw new Error('Please add at least one question');
            }

            questions.forEach((questionElement, index) => {
                const questionText = questionElement.querySelector('.question-text').value.trim();
                if (!questionText) {
                    throw new Error(`Question ${index + 1} is missing text`);
                }

                const questionType = questionElement.querySelector('.question-type-select').value;
                const options = Array.from(questionElement.querySelectorAll('.option-item')).map(opt => ({
                    text: opt.querySelector('.option-text').value.trim(),
                    isCorrect: opt.querySelector('.correct-checkbox').checked
                }));

                if (options.length < 2) {
                    throw new Error(`Question ${index + 1} must have at least 2 options`);
                }

                if (!options.some(opt => opt.text)) {
                    throw new Error(`Question ${index + 1} has empty options`);
                }

                const correctOptions = options.filter(opt => opt.isCorrect);
                if (correctOptions.length === 0) {
                    throw new Error(`Question ${index + 1} must have at least one correct answer`);
                }

                if (questionType === 'single' && correctOptions.length > 1) {
                    throw new Error(`Question ${index + 1} is single choice but has multiple correct answers selected`);
                }
            });
        }

        // Update the saveQuiz function to use custom modal
        async function saveQuiz() {
            try {
                // Validate quiz
                validateQuiz();
                
                const title = document.getElementById('quizTitle').value.trim();
                const description = document.getElementById('quizDescription').value.trim();
                
                const questions = Array.from(document.querySelectorAll('.question-item')).map(questionElement => {
                    // Get question text with null check
                    const questionTextElement = questionElement.querySelector('.question-text');
                    if (!questionTextElement) {
                        throw new Error('Question text element not found');
                    }
                    const questionText = questionTextElement.value.trim();

                    // Get question type with null check
                    const questionTypeElement = questionElement.querySelector('.question-type-select');
                    if (!questionTypeElement) {
                        throw new Error('Question type element not found');
                    }
                    const questionType = questionTypeElement.value;

                    const options = [];
                    const correctAnswers = [];
                    
                    // Get all option items
                    const optionItems = questionElement.querySelectorAll('.option-item');
                    if (!optionItems || optionItems.length === 0) {
                        throw new Error('No options found for question');
                    }

                    optionItems.forEach((optionElement, index) => {
                        // Get option text with null check
                        const optionTextElement = optionElement.querySelector('.option-text');
                        if (!optionTextElement) {
                            throw new Error(`Option text element not found for option ${index + 1}`);
                        }
                        const optionText = optionTextElement.value.trim();

                        // Get correct checkbox with null check
                        const correctCheckbox = optionElement.querySelector('.correct-checkbox');
                        if (!correctCheckbox) {
                            throw new Error(`Correct checkbox not found for option ${index + 1}`);
                        }
                        const isCorrect = correctCheckbox.checked;
                        
                        if (optionText) {
                            options.push(optionText);
                            if (isCorrect) {
                                correctAnswers.push(optionText);
                            }
                        }
                    });

                    // Create question object based on type
                    const questionData = {
                        question: questionText,
                        type: questionType,
                        options: options
                    };

                    // Add correct answer(s) based on question type
                    if (questionType === 'single') {
                        questionData.correctAnswer = correctAnswers[0] || '';
                    } else {
                        questionData.correctAnswers = correctAnswers;
                    }

                    return questionData;
                });

                const quiz = {
                    title,
                    description,
                    questions,
                    created: Date.now()
                };

                // Get password if needed
                const password = await showPasswordModal(
                    'Set Quiz Password (Optional)', 
                    'Leave blank for no password protection'
                );
                
                if (password === null) return; // User cancelled
                
                // Encrypt the quiz
                const encryptedQuiz = await CryptoUtils.encrypt(quiz, password || '');
                
                // Generate file for download
                const blob = new Blob([JSON.stringify(encryptedQuiz)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `${title.toLowerCase().replace(/[^a-z0-9]/g, '-')}.qowl`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // Also store the quiz locally
                storeQuiz(quiz);
                
                showToast('Quiz saved successfully!', 'success');
                
                // Show custom modal for creating another quiz
                showConfirmModal(
                    'Quiz Saved',
                    'Would you like to create another quiz?',
                    () => {
                        resetQuizForm();
                        showToast('Started new quiz', 'success');
                    }
                );
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // Reset quiz form
        function resetQuizForm() {
            document.getElementById('quizTitle').value = '';
            document.getElementById('quizDescription').value = '';
            document.getElementById('questionsContainer').innerHTML = '';
            addQuestion(); // Add first question automatically
        }

        // Update the showConfirmModal function to be more flexible
        function showConfirmModal(title, message, onConfirm, confirmText = 'Confirm', confirmStyle = '') {
            const modalHTML = `
                <div class="confirm-modal">
                    <div class="confirm-modal-content">
                        <div class="confirm-modal-header">
                            <i class="fas fa-question-circle"></i>
                            <h3>${title}</h3>
                        </div>
                        <div class="confirm-modal-body">
                            ${message}
                        </div>
                        <div class="confirm-modal-actions">
                            <button class="btn btn-secondary" onclick="closeConfirmModal(this)">
                                Cancel
                            </button>
                            <button class="btn btn-primary" style="${confirmStyle}" onclick="confirmAction(this)">
                                ${confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = document.querySelector('.confirm-modal');
            
            // Force reflow
            modal.offsetHeight;
            modal.classList.add('show');
            
            // Store the confirmation callback
            modal.dataset.onConfirm = onConfirm.toString();
        }

        function closeConfirmModal(button) {
            const modal = button.closest('.confirm-modal');
            modal.classList.remove('show');
            setTimeout(() => modal.remove(), 300);
        }

        function confirmAction(button) {
            const modal = button.closest('.confirm-modal');
            const onConfirm = new Function('return ' + modal.dataset.onConfirm)();
            closeConfirmModal(button);
            onConfirm();
        }

        // Update the deleteQuestion function to use the proper modal closing
        function deleteQuestion(questionNumber) {
            const questionsContainer = document.getElementById('questionsContainer');
            if (!questionsContainer) {
                showToast('Error: Questions container not found', 'error');
                return;
            }

            // Check if we have more than 2 questions
            const totalQuestions = questionsContainer.children.length;
            if (totalQuestions <= 2) {
                showToast('A quiz must have at least 2 questions', 'error');
                return;
            }

            // Find the question to delete
            const questionItem = document.querySelector(`[data-question="${questionNumber}"]`);
            if (!questionItem) {
                showToast('Question not found', 'error');
                return;
            }

            // Clean up event listeners before showing confirmation
            cleanupQuestionEventListeners(questionItem);

            // Get question text for confirmation
            const questionText = questionItem.querySelector('.question-text')?.value.trim() || 'Untitled Question';
            const previewText = questionText.length > 50 ? questionText.substring(0, 47) + '...' : questionText;

            // Show confirmation dialog
            const modalHTML = `
                <div class="confirm-modal">
                    <div class="confirm-modal-content">
                        <div class="confirm-modal-header">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Delete Question</h3>
                        </div>
                        <div class="confirm-modal-body">
                            <p>Are you sure you want to delete this question?</p>
                            <p class="text-secondary">"${previewText}"</p>
                        </div>
                        <div class="confirm-modal-actions">
                            <button class="btn btn-secondary" onclick="closeDeleteConfirmation()">
                                Cancel
                            </button>
                            <button class="btn btn-primary" style="background: var(--error);" 
                                    onclick="confirmQuestionDeletion(${questionNumber})">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Remove any existing confirmation modals
            const existingModal = document.querySelector('.confirm-modal');
            if (existingModal) {
                existingModal.remove();
            }

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = document.querySelector('.confirm-modal');
            requestAnimationFrame(() => modal.classList.add('show'));
        }

        function cleanupQuestionEventListeners(questionItem) {
            // Remove header click event
            const header = questionItem.querySelector('.question-header');
            if (header) {
                const newHeader = header.cloneNode(true);
                header.parentNode.replaceChild(newHeader, header);
            }

            // Remove delete button event
            const deleteBtn = questionItem.querySelector('.delete-btn');
            if (deleteBtn) {
                const newDeleteBtn = deleteBtn.cloneNode(true);
                deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
            }

            // Remove option-related events
            const optionElements = questionItem.querySelectorAll('.option-item');
            optionElements.forEach(option => {
                const newOption = option.cloneNode(true);
                option.parentNode.replaceChild(newOption, option);
            });

            // Remove question text input events
            const questionText = questionItem.querySelector('.question-text');
            if (questionText) {
                const newQuestionText = questionText.cloneNode(true);
                questionText.parentNode.replaceChild(newQuestionText, questionText);
            }
        }

        function closeDeleteConfirmation() {
            const modal = document.querySelector('.confirm-modal');
            if (modal) {
                modal.classList.remove('show');
                // Use requestAnimationFrame to ensure smooth animation
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        modal.remove();
                    }, 300); // Match the CSS transition duration
                });
            }
        }

        function confirmQuestionDeletion(questionNumber) {
            const questionItem = document.querySelector(`[data-question="${questionNumber}"]`);
            if (!questionItem) {
                showToast('Question not found', 'error');
                closeDeleteConfirmation();
                return;
            }

            // Add fade out animation
            questionItem.classList.add('fade-out');

            // Remove the question after animation
            setTimeout(() => {
                // Remove the question element
                questionItem.remove();
                
                // Update the remaining questions efficiently
                requestAnimationFrame(() => {
                    const questions = document.querySelectorAll('.question-item');
                    questions.forEach((question, index) => {
                        const newNumber = index + 1;
                        question.dataset.question = newNumber;
                        
                        // Update question number display
                        const numberSpan = question.querySelector('.question-number');
                        if (numberSpan) {
                            numberSpan.textContent = `Question ${newNumber}`;
                        }

                        // Update correct answer input names
                        const correctInputs = question.querySelectorAll('.correct-checkbox');
                        correctInputs.forEach(input => {
                            input.name = `correct-${newNumber}`;
                        });

                        // Reattach event listeners
                        attachQuestionEventListeners(question, newNumber);
                    });

                    showToast('Question deleted successfully', 'success');
                });
            }, 300);

            // Close the confirmation modal
            closeDeleteConfirmation();
        }

        function attachQuestionEventListeners(question, number) {
            // Attach header click event
            const header = question.querySelector('.question-header');
            if (header) {
                header.onclick = () => toggleQuestion(number);
            }

            // Attach delete button event
            const deleteBtn = question.querySelector('.delete-btn');
            if (deleteBtn) {
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteQuestion(number);
                };
            }

            // Attach option events
            const addOptionBtn = question.querySelector('.add-option-btn');
            if (addOptionBtn) {
                addOptionBtn.onclick = () => addOption(number);
            }

            // Attach question text input event
            const questionText = question.querySelector('.question-text');
            if (questionText) {
                questionText.oninput = () => updateQuestionPreview(questionText);
            }

            // Add question type change handler
            const typeSelect = question.querySelector('.question-type-select');
            if (typeSelect) {
                typeSelect.onchange = () => handleQuestionTypeChange(typeSelect);
            }

            // Update existing correct-checkboxes
            const questionType = typeSelect ? typeSelect.value : 'single';
            const correctCheckboxes = question.querySelectorAll('.correct-checkbox');
            correctCheckboxes.forEach(checkbox => {
                if (questionType === 'single') {
                    checkbox.onchange = () => {
                        if (checkbox.checked) {
                            correctCheckboxes.forEach(cb => {
                                if (cb !== checkbox) cb.checked = false;
                            });
                        }
                    };
                } else {
                    checkbox.onchange = () => {
                        const optionText = checkbox.closest('.option-item').querySelector('.option-text');
                        updateOptionPreview(optionText);
                    };
                }
            });
        }

        // Update the addQuestion function to properly set up delete functionality
        function addQuestion() {
            const questionsContainer = document.getElementById('questionsContainer');
            if (!questionsContainer) return;

            const questionNumber = questionsContainer.children.length + 1;
            
            const questionHTML = `
                <div class="question-item" data-question="${questionNumber}">
                    <div class="question-header">
                        <div class="header-content">
                            <span class="question-number">Question ${questionNumber}</span>
                            <span class="question-preview"></span>
                        </div>
                        <div class="question-controls">
                            <button type="button" class="question-control-btn delete-btn">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button type="button" class="question-control-btn collapse-indicator">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                    </div>
                    <div class="question-body">
                        <div class="form-group">
                            <label>Question Text</label>
                            <textarea class="form-input question-text" placeholder="Enter your question here..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Question Type</label>
                            <select class="form-input question-type-select">
                                <option value="single">Single Choice</option>
                                <option value="multiple">Multiple Choice</option>
                            </select>
                        </div>
                        <div class="options-section">
                            <label>Options</label>
                            <div class="options-container">
                                <!-- Options will be added here -->
                            </div>
                            <button type="button" class="add-option-btn">
                                <i class="fas fa-plus"></i> Add Option
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Use insertAdjacentHTML for better performance
            questionsContainer.insertAdjacentHTML('beforeend', questionHTML);
            
            // Get the newly added question item
            const newQuestion = questionsContainer.lastElementChild;
            
            // Attach event listeners efficiently
            attachQuestionEventListeners(newQuestion, questionNumber);
            
            // Add initial options using requestAnimationFrame for better performance
            requestAnimationFrame(() => {
                addOption(questionNumber);
                addOption(questionNumber);
            });
        }

        // Update the updateQuestionNumbers function
        function updateQuestionNumbers() {
            const questions = document.querySelectorAll('.question-item');
            questions.forEach((question, index) => {
                const number = index + 1;
                question.dataset.question = number;
                
                // Update question number text
                const numberSpan = question.querySelector('.question-number');
                if (numberSpan) {
                    numberSpan.textContent = `Question ${number}`;
                }
                
                // Update header click handler
                const header = question.querySelector('.question-header');
                if (header) {
                    header.onclick = () => toggleQuestion(number);
                }
                
                // Update delete button
                const deleteBtn = question.querySelector('.delete-btn');
                if (deleteBtn) {
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteQuestion(number);
                    };
                }
                
                // Update option input names
                const correctToggles = question.querySelectorAll('.correct-toggle input');
                correctToggles.forEach(input => {
                    input.name = `correct-${number}`;
                });
            });
        }

        // Toast notification utility with duplicate prevention
        function showToast(message, type = 'success') {
            // Create or get toast container
            let container = document.querySelector('.toast-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'toast-container';
                document.body.appendChild(container);
            }

            // Remove any existing toasts with the same message to prevent duplicates
            const existingToasts = container.querySelectorAll('.toast');
            existingToasts.forEach(toast => {
                if (toast.textContent.trim() === message) {
                    toast.remove();
                }
            });

            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;

            // Add to container
            container.appendChild(toast);

            // Force reflow and add show class
            toast.offsetHeight;
            toast.classList.add('show');

            // Remove after delay
            setTimeout(() => {
                toast.classList.add('hide');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Fix the handleFileImport function to properly store imported quizzes
        async function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const encryptedQuiz = JSON.parse(e.target.result);
                        if (encryptedQuiz.version !== 1) {
                            throw new Error('Unsupported quiz format version');
                        }

                        // Try to decrypt without password first
                        try {
                            const quiz = await CryptoUtils.decrypt(encryptedQuiz, '');
                            // Add necessary fields for stored quiz
                            const quizToStore = {
                                ...quiz,
                                id: Date.now().toString(36),
                                timestamp: Date.now()
                            };
                            // Store in localStorage
                            const storedQuizzes = JSON.parse(localStorage.getItem('storedQuizzes') || '[]');
                            storedQuizzes.push(quizToStore);
                            localStorage.setItem('storedQuizzes', JSON.stringify(storedQuizzes));
                            
                            showToast('Quiz imported successfully!', 'success');
                            showStoredQuizzes(); // Refresh the view
                        } catch {
                            // If decryption fails, show password modal
                            const password = await showPasswordModal(
                                'Enter Quiz Password',
                                'This quiz is password protected. Please enter the password to continue:'
                            );
                            
                            if (!password) return;
                            
                            try {
                                const quiz = await CryptoUtils.decrypt(encryptedQuiz, password);
                                // Add necessary fields for stored quiz
                                const quizToStore = {
                                    ...quiz,
                                    id: Date.now().toString(36),
                                    timestamp: Date.now()
                                };
                                // Store in localStorage
                                const storedQuizzes = JSON.parse(localStorage.getItem('storedQuizzes') || '[]');
                                storedQuizzes.push(quizToStore);
                                localStorage.setItem('storedQuizzes', JSON.stringify(storedQuizzes));
                                
                                showToast('Quiz imported successfully!', 'success');
                                showStoredQuizzes(); // Refresh the view
                            } catch {
                                showToast('Invalid password', 'error');
                            }
                        }
                    } catch (error) {
                        showToast('Invalid quiz file', 'error');
                    }
                };
                reader.readAsText(file);
            } catch (error) {
                showToast('Error reading file', 'error');
            }
        }

        // Update loadStoredQuizzes function with enhanced UI
        function loadStoredQuizzes() {
            const storedQuizzes = JSON.parse(localStorage.getItem('storedQuizzes') || '[]');
            const container = document.getElementById('storedQuizzesList');
            
            if (storedQuizzes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-folder-open"></i>
                        </div>
                        <h3>No Quizzes Yet</h3>
                        <p>Create your first quiz or import one to get started!</p>
                        <div class="empty-state-actions">
                            <button class="btn btn-primary" onclick="showCreateQuiz()">
                                <i class="fas fa-plus"></i> Create Quiz
                            </button>
                            <button class="btn btn-secondary" onclick="showImportQuiz()">
                                <i class="fas fa-file-import"></i> Import Quiz
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            // Add search and filter section
            container.innerHTML = `
                <div class="stored-quizzes-header">
                    <div class="search-filter-section">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="quizSearch" placeholder="Search quizzes..." 
                                   oninput="filterQuizzes()">
                        </div>
                        <div class="filter-options">
                            <select id="sortFilter" onchange="filterQuizzes()">
                                <option value="newest">Newest First</option>
                                <option value="oldest">Oldest First</option>
                                <option value="name-asc">Name (A-Z)</option>
                                <option value="name-desc">Name (Z-A)</option>
                                <option value="score-high">Highest Score</option>
                                <option value="score-low">Lowest Score</option>
                            </select>
                        </div>
                    </div>
                    <div class="quiz-stats-summary">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-book"></i>
                            </div>
                            <div class="stat-info">
                                <span class="stat-value">${storedQuizzes.length}</span>
                                <span class="stat-label">Total Quizzes</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-question-circle"></i>
                            </div>
                            <div class="stat-info">
                                <span class="stat-value">${storedQuizzes.reduce((sum, quiz) => sum + quiz.questions.length, 0)}</span>
                                <span class="stat-label">Total Questions</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="stat-info">
                                <span class="stat-value">${calculateAverageScore(storedQuizzes)}%</span>
                                <span class="stat-label">Average Score</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="quizzes-grid" id="quizzesGrid">
                    ${generateQuizCards(storedQuizzes)}
                </div>
            `;

            // Add styles for the new design
            const styleSheet = document.createElement('style');
            styleSheet.textContent = `
                .stored-quizzes-header {
                    margin-bottom: 2rem;
                }

                .search-filter-section {
                    display: flex;
                    gap: 1rem;
                    margin-bottom: 1.5rem;
                    flex-wrap: wrap;
                }

                .search-box {
                    flex: 1;
                    min-width: 250px;
                    position: relative;
                }

                .search-box i {
                    position: absolute;
                    left: 1rem;
                    top: 50%;
                    transform: translateY(-50%);
                    color: var(--text-secondary);
                }

                .search-box input {
                    width: 100%;
                    padding: 0.875rem 1rem 0.875rem 2.5rem;
                    background: var(--surface-dark);
                    border: 1px solid var(--border);
                    border-radius: var(--border-radius);
                    color: var(--text);
                    font-size: 0.95rem;
                    transition: all 0.2s ease;
                }

                .search-box input:focus {
                    border-color: var(--primary-color);
                    box-shadow: 0 0 0 2px var(--glow-color);
                    outline: none;
                }

                .filter-options select {
                    padding: 0.875rem 2rem 0.875rem 1rem;
                    background: var(--surface-dark);
                    border: 1px solid var(--border);
                    border-radius: var(--border-radius);
                    color: var(--text);
                    font-size: 0.95rem;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    appearance: none;
                    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236b7280'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
                    background-repeat: no-repeat;
                    background-position: right 0.75rem center;
                    background-size: 1.5em;
                }

                .filter-options select:focus {
                    border-color: var(--primary-color);
                    box-shadow: 0 0 0 2px var(--glow-color);
                    outline: none;
                }

                .quiz-stats-summary {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 1rem;
                    margin-top: 1.5rem;
                }

                .stat-card {
                    background: var(--surface-dark);
                    border-radius: var(--border-radius);
                    padding: 1.25rem;
                    display: flex;
                    align-items: center;
                    gap: 1rem;
                    transition: transform 0.2s ease;
                    border: 1px solid var(--border);
                }

                .stat-card:hover {
                    transform: translateY(-2px);
                }

                .stat-icon {
                    width: 48px;
                    height: 48px;
                    border-radius: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 1.5rem;
                    background: var(--primary-color);
                    color: var(--surface-dark);
                }

                .stat-info {
                    display: flex;
                    flex-direction: column;
                }

                .stat-value {
                    font-size: 1.5rem;
                    font-weight: bold;
                    color: var(--text);
                    line-height: 1;
                }

                .stat-label {
                    color: var(--text-secondary);
                    font-size: 0.9rem;
                    margin-top: 0.25rem;
                }

                .quizzes-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                    gap: 1.5rem;
                    margin-top: 1.5rem;
                }

                .quiz-card {
                    background: var(--surface-dark);
                    border-radius: var(--border-radius);
                    overflow: hidden;
                    border: 1px solid var(--border);
                    transition: all 0.3s ease;
                    position: relative;
                }

                .quiz-card:hover {
                    transform: translateY(-4px);
                    box-shadow: 0 4px 25px rgba(0, 0, 0, 0.2);
                }

                .quiz-card-header {
                    padding: 1.25rem;
                    border-bottom: 1px solid var(--border);
                    position: relative;
                }

                .quiz-title {
                    font-size: 1.25rem;
                    color: var(--text);
                    margin: 0;
                    padding-right: 1.5rem;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                }

                .quiz-title i {
                    color: var(--primary-color);
                    font-size: 1rem;
                }

                .quiz-meta {
                    margin-top: 0.5rem;
                    color: var(--text-secondary);
                    font-size: 0.875rem;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                }

                .quiz-stats {
                    padding: 1rem 1.25rem;
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 1rem;
                    background: var(--surface);
                }

                .stat-item {
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    color: var(--text-secondary);
                    font-size: 0.875rem;
                }

                .stat-item i {
                    color: var(--primary-color);
                }

                .quiz-description {
                    padding: 1.25rem;
                    color: var(--text-secondary);
                    font-size: 0.95rem;
                    line-height: 1.5;
                    border-bottom: 1px solid var(--border);
                }

                .quiz-actions {
                    padding: 1rem 1.25rem;
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 0.75rem;
                }

                .quiz-actions .btn {
                    padding: 0.75rem;
                    font-size: 0.95rem;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 0.5rem;
                    transition: all 0.2s ease;
                }

                .quiz-actions .btn i {
                    font-size: 1rem;
                }

                .quiz-actions .btn-primary {
                    background: var(--primary-color);
                    color: var(--surface-dark);
                    border: none;
                }

                .quiz-actions .btn-primary:hover {
                    background: var(--primary-dark);
                    transform: translateY(-2px);
                }

                .quiz-actions .btn-secondary {
                    background: var(--surface);
                    color: var(--text);
                    border: 1px solid var(--border);
                }

                .quiz-actions .btn-secondary:hover {
                    background: var(--surface-light);
                    border-color: var(--primary-color);
                    transform: translateY(-2px);
                }

                .empty-state {
                    text-align: center;
                    padding: 3rem 1.5rem;
                    background: var(--surface-dark);
                    border-radius: var(--border-radius);
                    border: 1px solid var(--border);
                }

                .empty-state-icon {
                    width: 80px;
                    height: 80px;
                    margin: 0 auto 1.5rem;
                    background: var(--surface);
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 2rem;
                    color: var(--primary-color);
                }

                .empty-state h3 {
                    color: var(--text);
                    font-size: 1.5rem;
                    margin-bottom: 0.75rem;
                }

                .empty-state p {
                    color: var(--text-secondary);
                    margin-bottom: 2rem;
                }

                .empty-state-actions {
                    display: flex;
                    gap: 1rem;
                    justify-content: center;
                }

                @media (max-width: 768px) {
                    .search-filter-section {
                        flex-direction: column;
                    }

                    .quiz-stats-summary {
                        grid-template-columns: 1fr;
                    }

                    .quizzes-grid {
                        grid-template-columns: 1fr;
                    }

                    .empty-state-actions {
                        flex-direction: column;
                    }

                    .empty-state-actions .btn {
                        width: 100%;
                    }
                }
            `;

            document.head.appendChild(styleSheet);
        }

        function generateQuizCards(quizzes) {
            return quizzes.map(quiz => {
                const totalQuestions = quiz.questions.length;
                const multipleChoiceCount = quiz.questions.filter(q => q.type === 'multiple').length;
                const singleChoiceCount = quiz.questions.filter(q => q.type === 'single').length;
                const hasPassword = quiz.password !== undefined && quiz.password !== '';
                const dateCreated = new Date(quiz.timestamp).toLocaleDateString();
                const timeCreated = new Date(quiz.timestamp).toLocaleTimeString();

                return `
                    <div class="quiz-card" data-quiz-id="${quiz.id}">
                        <div class="quiz-card-header">
                            <h3 class="quiz-title">
                                ${quiz.title}
                                ${hasPassword ? '<i class="fas fa-lock" title="Password Protected"></i>' : ''}
                            </h3>
                            <div class="quiz-meta">
                                <i class="fas fa-calendar"></i>
                                <span>Created ${dateCreated}</span>
                            </div>
                        </div>
                        <div class="quiz-stats">
                            <div class="stat-item">
                                <i class="fas fa-question-circle"></i>
                                <span>${totalQuestions} Questions</span>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-check-circle"></i>
                                <span>${singleChoiceCount} Single Choice</span>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-check-square"></i>
                                <span>${multipleChoiceCount} Multiple Choice</span>
                            </div>
                            ${quiz.lastScore !== undefined ? `
                                <div class="stat-item">
                                    <i class="fas fa-star"></i>
                                    <span>${quiz.lastScore}% Score</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="quiz-description">
                            ${quiz.description ? 
                                `<p>${quiz.description.length > 100 ? 
                                    quiz.description.substring(0, 97) + '...' : 
                                    quiz.description}</p>` : 
                                '<p class="text-muted">No description provided</p>'}
                        </div>
                        <div class="quiz-actions">
                            <button class="btn btn-primary" onclick="startQuiz('${quiz.id}')">
                                <i class="fas fa-play"></i>
                                Take Quiz
                            </button>
                            <button class="btn btn-secondary" onclick="showQuizOptions('${quiz.id}')">
                                <i class="fas fa-ellipsis-h"></i>
                                Options
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showQuizOptions(quizId) {
            const modalHTML = `
                <div class="confirm-modal">
                    <div class="confirm-modal-content">
                        <div class="confirm-modal-header">
                            <i class="fas fa-cog"></i>
                            <h3>Quiz Options</h3>
                        </div>
                        <div class="confirm-modal-body">
                            <div class="quiz-options-grid">
                                <button class="option-btn" onclick="exportQuiz('${quizId}'); closeConfirmModal(this)">
                                    <i class="fas fa-file-export"></i>
                                    <span>Export Quiz</span>
                                </button>
                                <button class="option-btn" onclick="editQuiz('${quizId}'); closeConfirmModal(this)">
                                    <i class="fas fa-edit"></i>
                                    <span>Edit Quiz</span>
                                </button>
                                <button class="option-btn" onclick="duplicateQuiz('${quizId}'); closeConfirmModal(this)">
                                    <i class="fas fa-copy"></i>
                                    <span>Duplicate Quiz</span>
                                </button>
                                <button class="option-btn delete" onclick="confirmDeleteQuiz('${quizId}'); closeConfirmModal(this)">
                                    <i class="fas fa-trash"></i>
                                    <span>Delete Quiz</span>
                                </button>
                            </div>
                        </div>
                        <div class="confirm-modal-actions">
                            <button class="btn btn-secondary" onclick="closeConfirmModal(this)">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = document.querySelector('.confirm-modal');
            
            // Force reflow
            modal.offsetHeight;
            modal.classList.add('show');

            // Add styles for the options grid
            const styleSheet = document.createElement('style');
            styleSheet.textContent = `
                .quiz-options-grid {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 1rem;
                    margin-bottom: 1rem;
                }

                .option-btn {
                    background: var(--surface-dark);
                    border: 1px solid var(--border);
                    border-radius: var(--border-radius);
                    padding: 1rem;
                    color: var(--text);
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    gap: 0.5rem;
                    transition: all 0.2s ease;
                    cursor: pointer;
                }

                .option-btn i {
                    font-size: 1.5rem;
                    color: var(--primary-color);
                }

                .option-btn:hover {
                    transform: translateY(-2px);
                    border-color: var(--primary-color);
                }

                .option-btn.delete {
                    color: var(--error);
                }

                .option-btn.delete i {
                    color: var(--error);
                }

                .option-btn.delete:hover {
                    background: var(--error);
                    color: var(--text);
                    border-color: var(--error);
                }

                .option-btn.delete:hover i {
                    color: var(--text);
                }

                @media (max-width: 480px) {
                    .quiz-options-grid {
                        grid-template-columns: 1fr;
                    }
                }
            `;

            document.head.appendChild(styleSheet);
        }

        function filterQuizzes() {
            const searchTerm = document.getElementById('quizSearch').value.toLowerCase();
            const sortBy = document.getElementById('sortFilter').value;
            const storedQuizzes = JSON.parse(localStorage.getItem('storedQuizzes') || '[]');
            
            // Filter quizzes
            let filteredQuizzes = storedQuizzes.filter(quiz => 
                quiz.title.toLowerCase().includes(searchTerm) ||
                (quiz.description && quiz.description.toLowerCase().includes(searchTerm))
            );
            
            // Sort quizzes
            filteredQuizzes.sort((a, b) => {
                switch (sortBy) {
                    case 'newest':
                        return b.timestamp - a.timestamp;
                    case 'oldest':
                        return a.timestamp - b.timestamp;
                    case 'name-asc':
                        return a.title.localeCompare(b.title);
                    case 'name-desc':
                        return b.title.localeCompare(a.title);
                    case 'score-high':
                        return (b.lastScore || 0) - (a.lastScore || 0);
                    case 'score-low':
                        return (a.lastScore || 0) - (b.lastScore || 0);
                    default:
                        return 0;
                }
            });
            
            // Update the grid
            const grid = document.getElementById('quizzesGrid');
            grid.innerHTML = generateQuizCards(filteredQuizzes);
        }

        function calculateAverageScore(quizzes) {
            const scores = quizzes
                .map(quiz => quiz.lastScore)
                .filter(score => score !== undefined);
            
            if (scores.length === 0) return 0;
            
            const average = scores.reduce((sum, score) => sum + score, 0) / scores.length;
            return Math.round(average);
        }

        function toggleQuestion(questionNumber) {
            const questionItem = document.querySelector(`[data-question="${questionNumber}"]`);
            const isCollapsed = questionItem.classList.toggle('collapsed');
            const collapseIndicator = questionItem.querySelector('.collapse-indicator i');
            
            if (isCollapsed) {
                collapseIndicator.classList.replace('fa-chevron-down', 'fa-chevron-right');
                const questionText = questionItem.querySelector('.question-text').value.trim() || 'Untitled Question';
                questionItem.querySelector('.question-preview').textContent = `: ${questionText.substring(0, 50)}${questionText.length > 50 ? '...' : ''}`;
            } else {
                collapseIndicator.classList.replace('fa-chevron-right', 'fa-chevron-down');
                questionItem.querySelector('.question-preview').textContent = '';
            }
        }

        function updateQuestionPreview(textarea) {
            const questionItem = textarea.closest('.question-item');
            if (questionItem.classList.contains('collapsed')) {
                const text = textarea.value.trim();
                questionItem.querySelector('.question-preview').textContent = text ? `: ${text.substring(0, 50)}${text.length > 50 ? '...' : ''}` : '';
            }
        }

        function handleQuestionTypeChange(select) {
            const questionItem = select.closest('.question-item');
            const optionsContainer = questionItem.querySelector('.options-container');
            const questionNumber = questionItem.dataset.question;
            const newType = select.value;
            
            // Store current checked states
            const checkedStates = Array.from(optionsContainer.querySelectorAll('.correct-checkbox')).map(input => ({
                optionIndex: Array.from(optionsContainer.querySelectorAll('.option-item')).indexOf(input.closest('.option-item')),
                checked: input.checked
            }));
            
            // Update all options with new input type
            optionsContainer.querySelectorAll('.option-item').forEach((optionItem, index) => {
                const correctToggle = optionItem.querySelector('.correct-toggle');
                const oldInput = correctToggle.querySelector('.correct-checkbox');
                
                // Create new input with correct type
                const newInput = document.createElement('input');
                newInput.type = newType === 'single' ? 'radio' : 'checkbox';
                newInput.name = `correct-${questionNumber}`;
                newInput.className = 'correct-checkbox';
                
                // Handle checked state based on question type
                if (newType === 'single') {
                    // For single choice, only keep the first checked option
                    const firstCheckedState = checkedStates.find(state => state.checked);
                    newInput.checked = firstCheckedState && firstCheckedState.optionIndex === index;
                } else {
                    // For multiple choice, restore previous checked state
                    const previousState = checkedStates.find(state => state.optionIndex === index);
                    newInput.checked = previousState ? previousState.checked : false;
                }
                
                // Replace old input
                oldInput.parentNode.replaceChild(newInput, oldInput);
            });
        }

        function addOption(questionNumber) {
            const questionItem = document.querySelector(`[data-question="${questionNumber}"]`);
            if (!questionItem) {
                showToast('Question not found', 'error');
                return;
            }

            const optionsContainer = questionItem.querySelector('.options-container');
            if (!optionsContainer) {
                showToast('Options container not found', 'error');
                return;
            }

            const optionNumber = optionsContainer.children.length + 1;
            const questionTypeSelect = questionItem.querySelector('.question-type-select');
            if (!questionTypeSelect) {
                showToast('Question type not found', 'error');
                return;
            }
            
            const questionType = questionTypeSelect.value;
            const inputType = questionType === 'single' ? 'radio' : 'checkbox';
            
            const optionHTML = `
                <div class="option-item">
                    <div class="option-input-group">
                        <input type="text" class="form-input option-text" placeholder="Option ${optionNumber}">
                        <label class="correct-toggle">
                            <input type="${inputType}" 
                                   name="correct-${questionNumber}" 
                                   class="correct-checkbox">
                            <span>Correct</span>
                        </label>
                    </div>
                    <button type="button" class="remove-option-btn" title="Remove Option">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            optionsContainer.insertAdjacentHTML('beforeend', optionHTML);
            
            const newOption = optionsContainer.lastElementChild;
            
            // Attach event listeners
            const optionText = newOption.querySelector('.option-text');
            if (optionText) {
                optionText.oninput = () => updateOptionPreview(optionText);
            }
            
            const removeBtn = newOption.querySelector('.remove-option-btn');
            if (removeBtn) {
                removeBtn.onclick = () => removeOption(removeBtn);
            }

            // Add event listener to the correct-checkbox
            const correctCheckbox = newOption.querySelector('.correct-checkbox');
            if (correctCheckbox) {
                if (questionType === 'single') {
                    // For single choice, ensure only one option is selected
                    correctCheckbox.onchange = () => {
                        if (correctCheckbox.checked) {
                            optionsContainer.querySelectorAll('.correct-checkbox').forEach(cb => {
                                if (cb !== correctCheckbox) cb.checked = false;
                            });
                        }
                    };
                } else {
                    // For multiple choice, allow independent toggling
                    correctCheckbox.onchange = () => updateOptionPreview(optionText);
                }
            }
        }

        function removeOption(button) {
            const optionItem = button.closest('.option-item');
            const optionsContainer = optionItem.parentElement;
            
            // Don't allow removing if only 2 options remain
            if (optionsContainer.children.length <= 2) {
                showToast('A question must have at least 2 options', 'error');
                return;
            }
            
            // Clean up event listeners
            const optionText = optionItem.querySelector('.option-text');
            if (optionText) {
                optionText.oninput = null;
            }
            
            // Add removing animation
            optionItem.classList.add('removing');
            
            // Remove after animation using requestAnimationFrame
            setTimeout(() => {
                requestAnimationFrame(() => {
                    optionItem.remove();
                    updateOptionNumbers(optionsContainer);
                });
            }, 300);
        }

        function updateOptionNumbers(container) {
            // Use requestAnimationFrame for better performance
            requestAnimationFrame(() => {
                const options = container.querySelectorAll('.option-text');
                options.forEach((input, index) => {
                    input.placeholder = `Option ${index + 1}`;
                });
            });
        }

        function updateOptionPreview(input) {
            const questionItem = input.closest('.question-item');
            if (!questionItem || !questionItem.classList.contains('collapsed')) {
                return;
            }

            // Use requestAnimationFrame for smoother UI updates
            requestAnimationFrame(() => {
                const preview = questionItem.querySelector('.question-preview');
                if (!preview) return;

                const allOptions = Array.from(questionItem.querySelectorAll('.option-text'))
                    .map(opt => opt.value.trim())
                    .filter(Boolean);

                preview.textContent = allOptions.length ? `: ${allOptions.join(', ')}` : '';
            });
        }

        // Add export functionality
        async function exportQuiz(quizId) {
            try {
                const storedQuizzes = JSON.parse(localStorage.getItem('storedQuizzes') || '[]');
                const quiz = storedQuizzes.find(q => q.id === quizId);
                
                if (!quiz) {
                    showToast('Quiz not found', 'error');
                    return;
                }

                // Get password if needed
                const password = await showPasswordModal(
                    'Set Export Password (Optional)', 
                    'Leave blank for no password protection'
                );
                
                if (password === null) return; // User cancelled
                
                // Encrypt the quiz
                const encryptedQuiz = await CryptoUtils.encrypt(quiz, password);
                
                // Generate file for download
                const blob = new Blob([JSON.stringify(encryptedQuiz)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `${quiz.title.toLowerCase().replace(/[^a-z0-9]/g, '-')}.qowl`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showToast('Quiz exported successfully!', 'success');
            } catch (error) {
                showToast('Failed to export quiz', 'error');
            }
        }

        // Add quiz view functions
        function renderCurrentQuestion() {
            const quiz = window.currentQuiz;
            const question = quiz.questions[window.currentQuestionIndex];
            const userAnswer = window.userAnswers[window.currentQuestionIndex] || [];
            
            const questionHTML = `
                <div class="question-container" id="question-${window.currentQuestionIndex}">
                    <div class="question-text">
                        <h3>Question ${window.currentQuestionIndex + 1}</h3>
                        <p>${question.question}</p>
                    </div>
                    <div class="options-list">
                        ${question.options.map((option, index) => `
                            <label class="option-item">
                                <input type="${question.type === 'single' ? 'radio' : 'checkbox'}"
                                       name="q${window.currentQuestionIndex}"
                                       value="${option}"
                                       onchange="handleAnswerSelection(this)"
                                       ${userAnswer.includes(option) ? 'checked' : ''}>
                                <span class="option-text">${option}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
            
            return questionHTML;
        }

        function handleAnswerSelection(input) {
            const questionIndex = window.currentQuestionIndex;
            const question = window.currentQuiz.questions[questionIndex];
            const selectedInputs = document.querySelectorAll(`input[name="q${questionIndex}"]:checked`);
            const selectedValues = Array.from(selectedInputs).map(input => input.value);
            
            // For single choice, ensure only one answer is stored
            if (question.type === 'single') {
                window.userAnswers[questionIndex] = selectedValues.slice(-1);
            } else {
                // For multiple choice, store all selected answers
                window.userAnswers[questionIndex] = selectedValues;
            }

            console.log(`Question ${questionIndex + 1} answers:`, window.userAnswers[questionIndex]); // Debug log
        }

        function generateProgressDots(total) {
            return Array(total).fill(0).map((_, i) => 
                `<div class="progress-dot${i === window.currentQuestionIndex ? ' active' : ''}" data-index="${i}"></div>`
            ).join('');
        }

        function updateNavigationState() {
            const quiz = window.currentQuiz;
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitContainer = document.getElementById('submitContainer');
            const questionProgress = document.getElementById('questionProgress');
            const progressDots = document.getElementById('progressDots');
            
            // Update buttons
            if (prevBtn) prevBtn.disabled = window.currentQuestionIndex === 0;
            
            if (window.currentQuestionIndex === quiz.questions.length - 1) {
                if (nextBtn) nextBtn.style.display = 'none';
                if (submitContainer) submitContainer.style.display = 'block';
            } else {
                if (nextBtn) nextBtn.style.display = 'block';
                if (submitContainer) submitContainer.style.display = 'none';
            }
            
            // Update progress
            if (questionProgress) {
                questionProgress.textContent = `Question ${window.currentQuestionIndex + 1} of ${quiz.questions.length}`;
            }
            
            // Update progress dots
            if (progressDots) {
                progressDots.innerHTML = generateProgressDots(quiz.questions.length);
            }
        }

        function previousQuestion() {
            if (window.currentQuestionIndex > 0) {
                const currentQuestion = document.getElementById(`question-${window.currentQuestionIndex}`);
                currentQuestion.classList.add('fade-out');
                
                setTimeout(() => {
                    window.currentQuestionIndex--;
                    document.getElementById('questionsContainer').innerHTML = renderCurrentQuestion();
                    const newQuestion = document.getElementById(`question-${window.currentQuestionIndex}`);
                    newQuestion.classList.add('fade-in');
                    updateNavigationState();
                }, 300);
            }
        }

        function nextQuestion() {
            if (window.currentQuestionIndex < window.currentQuiz.questions.length - 1) {
                const currentQuestion = document.getElementById(`question-${window.currentQuestionIndex}`);
                currentQuestion.classList.add('fade-out');
                
                setTimeout(() => {
                    window.currentQuestionIndex++;
                    document.getElementById('questionsContainer').innerHTML = renderCurrentQuestion();
                    const newQuestion = document.getElementById(`question-${window.currentQuestionIndex}`);
                    newQuestion.classList.add('fade-in');
                    updateNavigationState();
                }, 300);
            }
        }

        function submitQuiz(event) {
            event.preventDefault();
            const quiz = window.currentQuiz;
            let correctAnswers = 0;
            const results = [];

            quiz.questions.forEach((q, index) => {
                const userAnswers = window.userAnswers[index] || [];
                
                let isCorrect = false;
                if (q.type === 'single') {
                    isCorrect = userAnswers[0] === q.correctAnswer;
                } else {
                    isCorrect = q.correctAnswers.length === userAnswers.length &&
                        q.correctAnswers.every(answer => userAnswers.includes(answer));
                }
                
                if (isCorrect) correctAnswers++;
                
                results.push({
                    question: q.question,
                    isCorrect,
                    userAnswers: userAnswers.length > 0 ? userAnswers : 'Not answered',
                    correctAnswer: q.type === 'single' ? q.correctAnswer : q.correctAnswers
                });
            });

            const score = Math.round((correctAnswers / quiz.questions.length) * 100);
            showQuizResults(score, results);
            
            // Update stored quiz with new score
            updateStoredQuizScore(quiz.id, score);
        }

        function updateStoredQuizScore(quizId, score) {
            try {
                const storedQuizzes = JSON.parse(localStorage.getItem('storedQuizzes') || '[]');
                const updatedQuizzes = storedQuizzes.map(q => {
                    if (q.id === quizId) {
                        return { ...q, lastScore: score };
                    }
                    return q;
                });
                localStorage.setItem('storedQuizzes', JSON.stringify(updatedQuizzes));
            } catch (error) {
                console.error('Failed to update quiz score:', error);
            }
        }

        function showQuizResults(score, results) {
            // Hide all other views first
            const views = document.querySelectorAll('.landing-page, .quiz-builder-view, .stored-quizzes-view, .quiz-view');
            views.forEach(view => {
                if (view) view.style.display = 'none';
            });

            const resultsHTML = `
                <div class="quiz-results animate-fade">
                    <div class="results-header">
                        <div class="results-title">
                            <h2>${window.currentQuiz.title}</h2>
                            <p class="results-subtitle">Quiz Results</p>
                        </div>
                        <div class="score-summary">
                            <div class="score-circle ${getScoreClass(score)}">
                                <div class="score-content">
                                    <span class="score-value">${score}<small>%</small></span>
                                    <span class="score-label">${getScoreLabel(score)}</span>
                                </div>
                                <svg class="score-ring" viewBox="0 0 100 100">
                                    <circle class="score-ring-bg" cx="50" cy="50" r="45"/>
                                    <circle class="score-ring-progress" cx="50" cy="50" r="45" 
                                            style="stroke-dashoffset: ${440 - (440 * score) / 100}"/>
                                </svg>
                            </div>
                            <div class="score-stats">
                                <div class="stat-item correct">
                                    <div class="stat-icon">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <div class="stat-info">
                                        <span class="stat-value">${results.filter(r => r.isCorrect).length}</span>
                                        <span class="stat-label">Correct</span>
                                    </div>
                                </div>
                                <div class="stat-item incorrect">
                                    <div class="stat-icon">
                                        <i class="fas fa-times-circle"></i>
                                    </div>
                                    <div class="stat-info">
                                        <span class="stat-value">${results.filter(r => !r.isCorrect).length}</span>
                                        <span class="stat-label">Incorrect</span>
                                    </div>
                                </div>
                                <div class="stat-item total">
                                    <div class="stat-icon">
                                        <i class="fas fa-list"></i>
                                    </div>
                                    <div class="stat-info">
                                        <span class="stat-value">${results.length}</span>
                                        <span class="stat-label">Total Questions</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="results-content">
                        <div class="results-breakdown">
                            ${results.map((result, index) => `
                                <div class="result-item ${result.isCorrect ? 'correct' : 'incorrect'}" data-question="${index + 1}">
                                    <div class="result-header">
                                        <div class="result-number">
                                            <div class="number-badge">
                                                <span>${index + 1}</span>
                                            </div>
                                            <div class="result-status">
                                                ${result.isCorrect ? 
                                                    '<span class="status correct"><i class="fas fa-check"></i> Correct</span>' : 
                                                    '<span class="status incorrect"><i class="fas fa-times"></i> Incorrect</span>'
                                                }
                                            </div>
                                        </div>
                                        <div class="points-badge ${result.isCorrect ? 'correct' : 'incorrect'}">
                                            ${result.isCorrect ? '+1' : '+0'}
                                        </div>
                                    </div>
                                    <div class="result-body">
                                        <div class="question-text">${result.question}</div>
                                        <div class="answer-section">
                                            <div class="answer-group your-answer">
                                                <div class="answer-header">
                                                    <i class="fas fa-user"></i>
                                                    Your Answer
                                                </div>
                                                <div class="answer-content ${result.isCorrect ? 'correct' : 'incorrect'}">
                                                    ${Array.isArray(result.userAnswers) ? 
                                                        result.userAnswers.map(ans => `
                                                            <div class="answer-item">
                                                                <i class="fas fa-${result.isCorrect ? 'check' : 'times'}"></i>
                                                                ${ans}
                                                            </div>
                                                        `).join('') : 
                                                        `<div class="answer-item not-answered">
                                                            <i class="fas fa-minus-circle"></i>
                                                            Not Answered
                                                        </div>`
                                                    }
                                                </div>
                                            </div>
                                            ${!result.isCorrect ? `
                                                <div class="answer-group correct-answer">
                                                    <div class="answer-header">
                                                        <i class="fas fa-check-circle"></i>
                                                        Correct Answer
                                                    </div>
                                                    <div class="answer-content correct">
                                                        ${Array.isArray(result.correctAnswer) ? 
                                                            result.correctAnswer.map(ans => `
                                                                <div class="answer-item">
                                                                    <i class="fas fa-check"></i>
                                                                    ${ans}
                                                                </div>
                                                            `).join('') :
                                                            `<div class="answer-item">
                                                                <i class="fas fa-check"></i>
                                                                ${result.correctAnswer}
                                                            </div>`
                                                        }
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="results-actions">
                        <button class="btn btn-primary" onclick="retakeQuiz()">
                            <i class="fas fa-redo"></i> Retake Quiz
                        </button>
                        <button class="btn btn-secondary" onclick="showStoredQuizzes()">
                            <i class="fas fa-list"></i> Back to Quizzes
                        </button>
                    </div>
                </div>
            `;
            
            const container = document.querySelector('.container');
            container.innerHTML = resultsHTML;

            // Add these styles for the new results design
            const styleSheet = document.createElement('style');
            styleSheet.textContent = `
                .quiz-results {
                    max-width: 800px;
                    margin: 0 auto;
                    padding: 20px;
                }

                .results-title {
                    text-align: center;
                    margin-bottom: 30px;
                }

                .results-title h2 {
                    font-size: 2rem;
                    color: var(--primary-color);
                    margin-bottom: 5px;
                }

                .results-subtitle {
                    color: var(--text-secondary);
                    font-size: 1.1rem;
                }

                .score-summary {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    gap: 30px;
                    margin-top: 30px;
                    padding: 30px;
                    background: var(--surface-dark);
                    border-radius: var(--border-radius);
                    box-shadow: var(--shadow-md);
                }

                .score-circle {
                    width: 200px;
                    height: 200px;
                    position: relative;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }

                .score-content {
                    position: relative;
                    z-index: 2;
                    text-align: center;
                }

                .score-value {
                    font-size: 3.5rem;
                    font-weight: bold;
                    background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
                    -webkit-background-clip: text;
                    background-clip: text;
                    -webkit-text-fill-color: transparent;
                    line-height: 1;
                }

                .score-value small {
                    font-size: 1.5rem;
                    opacity: 0.8;
                }

                .score-label {
                    font-size: 1.2rem;
                    color: var(--text-secondary);
                    margin-top: 5px;
                    display: block;
                }

                .score-ring {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    transform: rotate(-90deg);
                }

                .score-ring circle {
                    fill: none;
                    stroke-width: 8;
                    stroke-linecap: round;
                }

                .score-ring-bg {
                    stroke: var(--surface-light);
                }

                .score-ring-progress {
                    stroke: var(--primary-color);
                    stroke-dasharray: 440;
                    transition: stroke-dashoffset 1s ease;
                }

                .score-stats {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                    gap: 20px;
                    width: 100%;
                }

                .stat-item {
                    background: var(--surface-light);
                    padding: 20px;
                    border-radius: var(--border-radius);
                    display: flex;
                    align-items: center;
                    gap: 15px;
                    transition: transform 0.3s ease;
                }

                .stat-item:hover {
                    transform: translateY(-2px);
                }

                .stat-icon {
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 1.2rem;
                }

                .stat-item.correct .stat-icon {
                    background: rgba(34, 197, 94, 0.1);
                    color: var(--success);
                }

                .stat-item.incorrect .stat-icon {
                    background: rgba(239, 68, 68, 0.1);
                    color: var(--error);
                }

                .stat-item.total .stat-icon {
                    background: rgba(135, 206, 235, 0.1);
                    color: var(--primary-color);
                }

                .stat-info {
                    display: flex;
                    flex-direction: column;
                }

                .stat-value {
                    font-size: 1.5rem;
                    font-weight: bold;
                    line-height: 1;
                }

                .stat-label {
                    color: var(--text-secondary);
                    font-size: 0.9rem;
                    margin-top: 4px;
                }

                .results-breakdown {
                    margin-top: 40px;
                    display: flex;
                    flex-direction: column;
                    gap: 20px;
                }

                .result-item {
                    background: var(--surface-dark);
                    border-radius: var(--border-radius);
                    overflow: hidden;
                    transition: all 0.3s ease;
                    border: 1px solid var(--border);
                }

                .result-item:hover {
                    transform: translateY(-2px);
                    box-shadow: var(--shadow-md);
                }

                .result-header {
                    padding: 15px 20px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    border-bottom: 1px solid var(--border);
                }

                .result-number {
                    display: flex;
                    align-items: center;
                    gap: 15px;
                }

                .number-badge {
                    width: 32px;
                    height: 32px;
                    border-radius: 50%;
                    background: var(--surface-light);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    font-size: 1.1rem;
                }

                .points-badge {
                    padding: 4px 12px;
                    border-radius: 12px;
                    font-weight: 600;
                    font-size: 0.9rem;
                }

                .points-badge.correct {
                    background: rgba(34, 197, 94, 0.1);
                    color: var(--success);
                }

                .points-badge.incorrect {
                    background: rgba(239, 68, 68, 0.1);
                    color: var(--error);
                }

                .result-status .status {
                    padding: 6px 12px;
                    border-radius: 12px;
                    font-size: 0.9rem;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                }

                .status.correct {
                    background: rgba(34, 197, 94, 0.1);
                    color: var(--success);
                }

                .status.incorrect {
                    background: rgba(239, 68, 68, 0.1);
                    color: var(--error);
                }

                .result-body {
                    padding: 20px;
                }

                .question-text {
                    font-size: 1.1rem;
                    margin-bottom: 20px;
                    color: var(--text);
                    line-height: 1.5;
                }

                .answer-section {
                    display: flex;
                    flex-direction: column;
                    gap: 20px;
                }

                .answer-group {
                    background: var(--surface-light);
                    border-radius: var(--border-radius);
                    overflow: hidden;
                }

                .answer-header {
                    padding: 12px 15px;
                    background: var(--surface);
                    color: var(--text-secondary);
                    font-size: 0.9rem;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    border-bottom: 1px solid var(--border);
                }

                .answer-content {
                    padding: 15px;
                }

                .answer-item {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    padding: 8px;
                    border-radius: var(--border-radius);
                }

                .answer-item:not(:last-child) {
                    margin-bottom: 8px;
                }

                .answer-content.correct .answer-item {
                    background: rgba(34, 197, 94, 0.1);
                    color: var(--success);
                }

                .answer-content.incorrect .answer-item {
                    background: rgba(239, 68, 68, 0.1);
                    color: var(--error);
                }

                .answer-item.not-answered {
                    background: rgba(245, 158, 11, 0.1);
                    color: var(--warning);
                }

                .results-actions {
                    display: flex;
                    gap: 15px;
                    margin-top: 40px;
                    justify-content: center;
                }

                .results-actions .btn {
                    min-width: 180px;
                    padding: 12px 24px;
                }

                @media (max-width: 768px) {
                    .quiz-results {
                        padding: 15px;
                    }

                    .score-circle {
                        width: 160px;
                        height: 160px;
                    }

                    .score-value {
                        font-size: 2.5rem;
                    }

                    .score-label {
                        font-size: 1rem;
                    }

                    .stat-item {
                        padding: 15px;
                    }

                    .stat-value {
                        font-size: 1.2rem;
                    }

                    .results-actions {
                        flex-direction: column;
                    }

                    .results-actions .btn {
                        width: 100%;
                    }
                }
            `;

            document.head.appendChild(styleSheet);

            // Animate the score ring after a short delay
            setTimeout(() => {
                const ring = document.querySelector('.score-ring-progress');
                if (ring) {
                    ring.style.strokeDashoffset = 440 - (440 * score) / 100;
                }
            }, 100);
        }

        function getScoreClass(score) {
            if (score >= 90) return 'excellent';
            if (score >= 75) return 'good';
            if (score >= 60) return 'fair';
            return 'needs-improvement';
        }

        function getScoreLabel(score) {
            if (score >= 90) return 'Excellent!';
            if (score >= 75) return 'Good Job!';
            if (score >= 60) return 'Fair';
            return 'Needs Improvement';
        }

        function retakeQuiz() {
            if (window.currentQuiz) {
                // Reshuffle questions and reset state
                window.currentQuiz.questions = shuffleArray([...window.currentQuiz.questions]);
                window.currentQuestionIndex = 0;
                window.userAnswers = new Array(window.currentQuiz.questions.length).fill(null).map(() => []);
                showQuizView();
            }
        }

        // Update the mobile styles in the loadStoredQuizzes function
        const mobileStyles = `
            /* Mobile-first responsive styles */
            @media (max-width: 768px) {
                .stored-quizzes-header {
                    margin-bottom: 1rem;
                    padding: 0;
                }

                .search-filter-section {
                    flex-direction: column;
                    gap: 0.75rem;
                    margin-bottom: 1rem;
                }

                .search-box {
                    width: 100%;
                    min-width: unset;
                }

                .search-box input {
                    padding: 0.75rem 1rem 0.75rem 2.5rem;
                    font-size: 1rem;
                }

                .filter-options {
                    width: 100%;
                }

                .filter-options select {
                    width: 100%;
                    padding: 0.75rem 1rem;
                    font-size: 1rem;
                }

                .quiz-stats-summary {
                    grid-template-columns: 1fr;
                    gap: 0.75rem;
                    margin-top: 1rem;
                    padding: 0.75rem;
                }

                .stat-card {
                    padding: 1rem;
                    gap: 0.75rem;
                }

                .stat-icon {
                    width: 40px;
                    height: 40px;
                    font-size: 1.25rem;
                }

                .stat-value {
                    font-size: 1.25rem;
                }

                .stat-label {
                    font-size: 0.875rem;
                }

                .quizzes-grid {
                    grid-template-columns: 1fr;
                    gap: 1rem;
                    margin-top: 1rem;
                    padding: 0;
                }

                .quiz-card {
                    margin: 0;
                }

                .quiz-card-header {
                    padding: 1rem;
                }

                .quiz-title {
                    font-size: 1.1rem;
                    padding-right: 1rem;
                }

                .quiz-meta {
                    font-size: 0.8rem;
                }

                .quiz-stats {
                    padding: 0.75rem;
                    grid-template-columns: 1fr 1fr;
                    gap: 0.75rem;
                }

                .stat-item {
                    font-size: 0.8rem;
                    gap: 0.375rem;
                }

                .quiz-description {
                    padding: 1rem;
                    font-size: 0.9rem;
                }

                .quiz-actions {
                    padding: 0.75rem;
                    gap: 0.5rem;
                }

                .quiz-actions .btn {
                    padding: 0.625rem;
                    font-size: 0.9rem;
                }

                /* Quiz Options Modal Mobile Styles */
                .confirm-modal-content {
                    width: 95%;
                    margin: 1rem;
                    padding: 1rem;
                }

                .quiz-options-grid {
                    grid-template-columns: 1fr;
                    gap: 0.75rem;
                }

                .option-btn {
                    padding: 0.875rem;
                    font-size: 0.9rem;
                }

                .option-btn i {
                    font-size: 1.25rem;
                }

                /* Empty State Mobile Styles */
                .empty-state {
                    padding: 2rem 1rem;
                }

                .empty-state-icon {
                    width: 60px;
                    height: 60px;
                    font-size: 1.5rem;
                    margin-bottom: 1rem;
                }

                .empty-state h3 {
                    font-size: 1.25rem;
                    margin-bottom: 0.5rem;
                }

                .empty-state p {
                    font-size: 0.9rem;
                    margin-bottom: 1.5rem;
                }

                .empty-state-actions {
                    flex-direction: column;
                    gap: 0.75rem;
                }

                .empty-state-actions .btn {
                    width: 100%;
                    padding: 0.75rem;
                    font-size: 0.9rem;
                }
            }

            /* Small mobile devices */
            @media (max-width: 360px) {
                .quiz-card-header {
                    padding: 0.75rem;
                }

                .quiz-title {
                    font-size: 1rem;
                }

                .quiz-meta {
                    font-size: 0.75rem;
                }

                .quiz-stats {
                    padding: 0.625rem;
                    grid-template-columns: 1fr;
                }

                .stat-item {
                    font-size: 0.75rem;
                }

                .quiz-description {
                    padding: 0.75rem;
                    font-size: 0.85rem;
                }

                .quiz-actions {
                    padding: 0.625rem;
                    flex-direction: column;
                }

                .quiz-actions .btn {
                    width: 100%;
                    padding: 0.625rem;
                    font-size: 0.85rem;
                }
            }

            /* Touch-friendly improvements */
            @media (hover: none) {
                .quiz-card:hover {
                    transform: none;
                    box-shadow: var(--shadow-sm);
                }

                .stat-card:hover {
                    transform: none;
                }

                .quiz-actions .btn {
                    min-height: 44px; /* Minimum touch target size */
                }

                .option-btn {
                    min-height: 44px;
                }

                .search-box input,
                .filter-options select {
                    min-height: 44px;
                }

                /* Add active state for touch devices */
                .quiz-card:active {
                    transform: translateY(-2px);
                    transition: transform 0.1s ease;
                }

                .stat-card:active {
                    transform: translateY(-1px);
                    transition: transform 0.1s ease;
                }

                .btn:active,
                .option-btn:active {
                    opacity: 0.8;
                    transform: translateY(1px);
                    transition: all 0.1s ease;
                }
            }

            /* Safe area insets for modern mobile devices */
            @supports (padding: max(0px)) {
                .stored-quizzes-header {
                    padding-left: max(1rem, env(safe-area-inset-left));
                    padding-right: max(1rem, env(safe-area-inset-right));
                }

                .quizzes-grid {
                    padding-left: max(1rem, env(safe-area-inset-left));
                    padding-right: max(1rem, env(safe-area-inset-right));
                    padding-bottom: max(1rem, env(safe-area-inset-bottom));
                }
            }

            /* Dark mode adjustments for OLED screens */
            @media (prefers-color-scheme: dark) and (max-width: 768px) {
                .quiz-card,
                .stat-card,
                .empty-state {
                    background-color: rgba(0, 0, 0, 0.3);
                }

                .quiz-stats {
                    background-color: rgba(0, 0, 0, 0.2);
                }

                .search-box input,
                .filter-options select {
                    background-color: rgba(0, 0, 0, 0.2);
                }
            }

            /* Loading state for better perceived performance */
            .quiz-card-skeleton {
                background: var(--surface-dark);
                border-radius: var(--border-radius);
                overflow: hidden;
                border: 1px solid var(--border);
                height: 280px;
                position: relative;
            }

            .quiz-card-skeleton::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(
                    90deg,
                    transparent,
                    rgba(255, 255, 255, 0.05),
                    transparent
                );
                animation: shimmer 1.5s infinite;
            }

            @keyframes shimmer {
                0% { transform: translateX(-100%); }
                100% { transform: translateX(100%); }
            }

            /* Pull-to-refresh indicator */
            .pull-indicator {
                height: 50px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--text-secondary);
                font-size: 0.9rem;
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .pull-indicator.visible {
                opacity: 1;
            }

            .pull-indicator i {
                margin-right: 8px;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;

        // Add the mobile styles to the existing styleSheet
        styleSheet.textContent += mobileStyles;

        // Add touch event handlers for pull-to-refresh
        function initializePullToRefresh() {
            let startY = 0;
            let pullDistance = 0;
            const container = document.querySelector('.stored-quizzes');
            const pullIndicator = document.createElement('div');
            pullIndicator.className = 'pull-indicator';
            pullIndicator.innerHTML = '<i class="fas fa-sync-alt"></i> Pull to refresh';
            container.insertBefore(pullIndicator, container.firstChild);

            container.addEventListener('touchstart', (e) => {
                if (container.scrollTop === 0) {
                    startY = e.touches[0].pageY;
                }
            }, { passive: true });

            container.addEventListener('touchmove', (e) => {
                if (startY > 0) {
                    pullDistance = e.touches[0].pageY - startY;
                    if (pullDistance > 0 && pullDistance < 100) {
                        pullIndicator.style.height = `${pullDistance}px`;
                        pullIndicator.classList.add('visible');
                    }
                }
            }, { passive: true });

            container.addEventListener('touchend', () => {
                if (pullDistance > 50) {
                    // Refresh the stored quizzes
                    loadStoredQuizzes();
                }
                startY = 0;
                pullDistance = 0;
                pullIndicator.style.height = '0';
                pullIndicator.classList.remove('visible');
            });
        }

        // Initialize pull-to-refresh after loading stored quizzes
        document.addEventListener('DOMContentLoaded', () => {
            if (document.querySelector('.stored-quizzes')) {
                initializePullToRefresh();
            }
        });
    </script>
</body>
</html> 